<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Categoría para los grupos de la Universidad -->
    <record id="categoria_universidad" model="ir.module.category">
        <field name="name">Universidad eLearning</field>
        <field name="description">Gestión de roles universitarios</field>
    </record>

    <!-- Rol: Personal Docente -->
    <record id="grupo_personal_docente" model="res.groups">
        <field name="name">Personal Docente</field>
        <field name="category_id" ref="categoria_universidad"/>
        <field name="implied_ids" eval="[(4, ref('base.group_user'))]"/>
    </record>

    <!-- Rol: Director Académico -->
    <record id="grupo_director_academico" model="res.groups">
        <field name="name">Director Académico</field>
        <field name="category_id" ref="categoria_universidad"/>
        <field name="implied_ids" eval="[(4, ref('grupo_personal_docente'))]"/>
    </record>

    <!-- Rol: Administrador de Universidad -->
    <record id="grupo_administrador_universidad" model="res.groups">
        <field name="name">Administrador de Universidad</field>
        <field name="category_id" ref="categoria_universidad"/>
        <field name="implied_ids" eval="[(4, ref('grupo_director_academico'))]"/>
        <field name="users" eval="[(4, ref('base.user_root')), (4, ref('base.user_admin'))]"/>
    </record>


    <!-- Regla: Profesores ven los Masters de sus Asignaturas (Solo Lectura) -->
    <!-- RE-ACTIVADA y SIMPLIFICADA: Permite ver todos los Masters para evitar errores de acceso al padre en Asignaturas -->
    <!-- Regla: Profesores ven los Masters de sus Asignaturas (Solo Lectura) -->
    <!-- CRITICO: Esta regla permite que el profesor lea el registro del Master Padre para pintar las migas de pan (Breadcrumbs) -->
    <!-- Sin esto, al entrar en una asignatura, Odoo falla por 'Access Denied' al intentar leer master_id.display_name -->
    <record id="rule_universidad_channel_master_for_asig" model="ir.rule">
        <field name="name">Universidad: Profesores ven Masters de sus Asignaturas</field>
        <field name="active" eval="True"/>
        <field name="model_id" ref="website_slides.model_slide_channel"/>
        <field name="groups" eval="[(4, ref('grupo_personal_docente'))]"/>
        <field name="domain_force">[('tipo_curso', '=', 'master'), ('all_personal_docente_ids', 'in', [user.id])]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Regla: Calificaciones y Boletines (Masters y Microcredenciales asignadas) -->
    <record id="rule_universidad_channel_partner_responsable" model="ir.rule">
        <field name="name">Universidad: Ver calificaciones de sus alumnos</field>
        <field name="model_id" ref="website_slides.model_slide_channel_partner"/>
        <field name="groups" eval="[(4, ref('grupo_personal_docente')), (4, ref('grupo_director_academico'))]"/>
        <field name="domain_force">['|', ('channel_id.director_academico_ids', 'in', [user.id]), ('channel_id.all_personal_docente_ids', 'in', [user.id])]</field>
    </record>

    <!-- Regla: Evaluaciones de Contenido (Acceso para Docentes/Directores asignados) -->
    <record id="rule_universidad_slide_partner_responsable" model="ir.rule">
        <field name="name">Universidad: Evaluar solo sus contenidos asignados</field>
        <field name="model_id" ref="website_slides.model_slide_slide_partner"/>
        <field name="groups" eval="[(4, ref('grupo_personal_docente')), (4, ref('grupo_director_academico'))]"/>
        <field name="domain_force">['|', ('channel_id.director_academico_ids', 'in', [user.id]), ('channel_id.all_personal_docente_ids', 'in', [user.id])]</field>
    </record>

    <!-- Regla: Acceso a Contenidos (Slides) para Docentes/Directores -->
    <record id="rule_universidad_slide_responsable" model="ir.rule">
        <field name="name">Universidad: Ver/Editar contenidos de sus cursos</field>
        <field name="model_id" ref="website_slides.model_slide_slide"/>
        <field name="groups" eval="[(4, ref('grupo_personal_docente')), (4, ref('grupo_director_academico'))]"/>
        <field name="domain_force">['|', '|', ('channel_id.create_uid', '=', user.id), ('channel_id.director_academico_ids', 'in', [user.id]), ('channel_id.all_personal_docente_ids', 'in', [user.id])]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Regla: Administrador ve TODO (Bypass) -->
    <record id="rule_universidad_admin_all" model="ir.rule">
        <field name="name">Universidad Administrador: Sin restricciones</field>
        <field name="model_id" ref="website_slides.model_slide_channel"/>
        <field name="groups" eval="[(4, ref('grupo_administrador_universidad'))]"/>
        <field name="domain_force">[(1, '=', 1)]</field>
    </record>

    <record id="rule_universidad_admin_partner_all" model="ir.rule">
        <field name="name">Universidad Administrador: Ver todas calificaciones</field>
        <field name="model_id" ref="website_slides.model_slide_channel_partner"/>
        <field name="groups" eval="[(4, ref('grupo_administrador_universidad'))]"/>
        <field name="domain_force">[(1, '=', 1)]</field>
    </record>
    <record id="rule_universidad_admin_slide_partner_all" model="ir.rule">
        <field name="name">Universidad Administrador: Ver todas evaluaciones</field>
        <field name="model_id" ref="website_slides.model_slide_slide_partner"/>
        <field name="groups" eval="[(4, ref('grupo_administrador_universidad'))]"/>
        <field name="domain_force">[(1, '=', 1)]</field>
    </record>
    <!-- DESACTIVACIÓN DE REGLAS NATIVAS CONFLICTIVAS -->
    <!-- Desactivamos la regla que permite a cualquier usuario interno ver todos los cursos publicados -->
    <!-- ESTRATEGIA: Restricción TOTAL (False) para que solo nuestras reglas sumen permisos. -->
    <record id="website_slides.rule_slide_channel_visibility_signed_in_user" model="ir.rule">
        <field name="active" eval="True"/>
        <field name="domain_force">[(1, '=', 0)]</field>
    </record>

    <!-- Desactivamos la regla pública global por precaución -->
    <record id="website_slides.rule_slide_channel_visibility_public_user" model="ir.rule">
        <field name="active" eval="True"/>
        <field name="domain_force">[(1, '=', 0)]</field>
    </record>

    <!-- REGLA PRINCIPAL: Responsables (Docentes/Directores) -->
    <!-- Alineada 100% con el _search del modelo para consistencia -->
    <record id="rule_universidad_channel_responsable" model="ir.rule">
        <field name="name">Universidad: Ver sus propios cursos</field>
        <field name="model_id" ref="website_slides.model_slide_channel"/>
        <field name="groups" eval="[(4, ref('grupo_personal_docente')), (4, ref('grupo_director_academico'))]"/>
        <field name="domain_force">['|', '|', ('create_uid', '=', user.id), ('director_academico_ids', 'in', [user.id]), ('all_personal_docente_ids', 'in', [user.id])]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- REGLA ADICIONAL: Asignaturas Huérfanas (Sin Master) -->
    <!-- Separa la lógica para evitar errores de sintaxis en notación polaca compleja -->
    <!-- Permite a los docentes/directores ver y reclamar asignaturas libres -->
    <record id="rule_universidad_channel_orphans" model="ir.rule">
        <field name="name">Universidad: Ver asignaturas disponibles (Huérfanas)</field>
        <field name="model_id" ref="website_slides.model_slide_channel"/>
        <field name="groups" eval="[(4, ref('grupo_personal_docente')), (4, ref('grupo_director_academico'))]"/>
        <field name="domain_force">['&amp;', ('tipo_curso', '=', 'asignatura'), ('master_id', '=', False)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>



</odoo>
