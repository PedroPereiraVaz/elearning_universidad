<?xml version="1.0" ?>
<odoo>
    <data>
        <!-- 1. Custom Slide Category Template: Delivery (Entregable) -->
        <template id="slide_content_detailed_delivery_academy" inherit_id="website_slides.slide_content_detailed">
             <xpath expr="//div[@t-if=&quot;slide.slide_category == 'article'&quot;]" position="after">
                 <div t-if="slide.slide_category == 'delivery'" class="o_wslides_lesson_content_type">
                    <div class="container py-3">
                        <div t-if="not slide.channel_id.is_member" class="alert alert-info" role="alert">
                            <h4 class="alert-heading">Inscripci칩n Requerida</h4>
                            <p>Debes unirte a este curso para enviar tu trabajo.</p>
                        </div>
                        
                        <div t-else="" class="card">
                            <t t-set="user_membership" t-value="slide.sudo().user_membership_id"/>
                            <div class="card-header bg-primary text-white">
                                <h3 class="card-title mb-0"><i class="fa fa-upload"/> Entrega de Proyecto</h3>
                            </div>
                            <div class="card-body">
                                <div t-if="user_membership and user_membership.status == 'graded'" class="alert alert-success">
                                    <h4><i class="fa fa-check"/> Calificado</h4>
                                    <p><strong>Nota:</strong> <span t-field="user_membership.teacher_grade"/> / <span t-field="slide.delivery_max_score"/></p>
                                    <p t-if="user_membership.teacher_feedback"><strong>Retroalimentaci칩n:</strong> <span t-field="user_membership.teacher_feedback"/></p>
                                </div>
                                <div t-elif="user_membership and user_membership.status == 'submitted'" class="alert alert-warning">
                                    <h4><i class="fa fa-clock-o"/> Entregado - Esperando Revisi칩n</h4>
                                    <p>Tu archivo <strong><span t-field="user_membership.delivery_filename"/></strong> fue entregado el <span t-field="user_membership.delivery_date"/>.</p>
                                </div>
                                
                                <form t-if="not user_membership or user_membership.status != 'graded'" action="/academy/delivery/upload" method="post" enctype="multipart/form-data">
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                    <input type="hidden" name="slide_id" t-att-value="slide.id"/>
                                    
                                    <div class="mb-3">
                                        <label for="file" class="form-label">Sube tu archivo (PDF, Zip, etc.)</label>
                                        <input class="form-control" type="file" name="file" required="required"/>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Enviar Trabajo</button>
                                </form>
                            </div>
                        </div>
                    </div>
                 </div>
             </xpath>
        </template>

        <template id="slide_fullscreen_sidebar_category_academy" inherit_id="website_slides.slide_fullscreen_sidebar_category">
            <xpath expr="//li[hasclass('o_wslides_fs_sidebar_list_item')]" position="attributes">
                <attribute name="t-att-data-category">'infographic' if slide.slide_category == 'delivery' else slide.slide_category</attribute>
                <attribute name="t-att-data-embed-code">slide.embed_code if slide.slide_category in ['video', 'document', 'infographic', 'delivery'] else False</attribute>
            </xpath>
            <xpath expr="//div[hasclass('o_wslides_sidebar_content')]/a[@t-if='can_access']" position="replace">
                <a t-if="can_access" 
                   t-att-class="'d-block' if slide.slide_category != 'delivery' else 'd-block o_academy_force_exit'" 
                   t-att-href="(slide.website_url + '?fullscreen=1') if slide.slide_category == 'sub_course' else (slide.website_url if slide.slide_category == 'delivery' else '#')"
                   t-att-target="'_top' if slide.slide_category == 'delivery' else False"
                   t-att-onclick="'event.stopPropagation();' if slide.slide_category in ['sub_course', 'delivery'] else 'if(this.getAttribute(\'href\') === \'#\') { event.preventDefault(); }'">
                    <div class="d-flex align-items-center">
                        <t t-if="is_member" t-call="website_slides.slide_sidebar_done_button"/>
                        <i t-else="" t-attf-class="fa #{slide.slide_icon_class} me-2"/>
                        <div class="o_wslides_fs_slide_name text-truncate" t-esc="slide.name"/>
                    </div>
                </a>
            </xpath>
        </template>
        
        <template id="course_slides_list_slide_academy" inherit_id="website_slides.course_slides_list_slide">
             <xpath expr="//a[hasclass('o_wslides_js_slides_list_slide_link')]" position="replace">
                <a t-if="not invite_preview and (slide.is_preview or channel.is_member or channel.can_publish)" 
                   class="o_wslides_js_slides_list_slide_link" 
                   t-att-href="(slide.website_url + '?fullscreen=1') if slide.slide_category == 'sub_course' else '/slides/slide/%s' % slug(slide)">
                    <span t-field="slide.name"/>
                </a>
             </xpath>
        </template>

        <template id="course_nav_academy" inherit_id="website_slides.course_nav">
            <xpath expr="//li[hasclass('breadcrumb-item')][1]" position="after">
                <li t-if="channel.sudo().master_channel_id" class="breadcrumb-item flex-shrink-0">
                    <a t-att-href="'/slides/%s' % slug(channel.sudo().master_channel_id)" t-esc="channel.sudo().master_channel_id.name"/>
                </li>
            </xpath>
        </template>

        <!-- 5. Fullscreen Navigation: Back to Master -->
        <template id="slide_fullscreen_academy" inherit_id="website_slides.slide_fullscreen">
            <!-- Header Button -->
            <xpath expr="//div[hasclass('ms-auto')]" position="inside">
                <a t-if="slide.channel_id.sudo().master_channel_id" class="d-flex align-items-center px-3 text-white" 
                   t-attf-href="/slides/slide/#{slug(slide.channel_id.containing_master_slide_ids[0])}?fullscreen=1" 
                   title="Volver al Curso Principal">
                    <i class="fa fa-level-up me-1"/><span class="d-none d-md-inline-block">Volver al Master</span>
                </a>
            </xpath>
            <!-- Sidebar Header Link -->
            <xpath expr="//div[hasclass('o_wslides_fs_sidebar_header')]" position="inside">
                <a t-if="slide.channel_id.sudo().master_channel_id" class="d-block mt-2 small text-600" 
                   t-attf-href="/slides/slide/#{slug(slide.channel_id.containing_master_slide_ids[0])}?fullscreen=1">
                    <i class="fa fa-arrow-left me-1"/> Regresar al Master
                </a>
            </xpath>
        </template>

        <template id="embed_slide_academy" inherit_id="website_slides.embed_slide">
            <!-- Redirect deliverables out of fullscreen -->
            <xpath expr="//div[1]" position="inside">
                 <div t-if="slide.slide_category == 'delivery'" class="d-flex flex-column align-items-center justify-content-center h-100 bg-white p-5 text-center">
                    <div class="mb-4">
                        <i class="fa fa-refresh fa-spin fa-3x text-primary"/>
                    </div>
                    <h3 class="fw-bold">Abriendo entregable...</h3>
                    <p class="text-muted mb-4">Para garantizar que tus archivos se suban correctamente, los entregables deben gestionarse desde la vista est치ndar del curso.</p>
                    <a t-att-href="slide.website_url" class="btn btn-primary btn-lg px-5 shadow-sm" target="_top">
                        <i class="fa fa-external-link me-2"/> Ir al Entregable Ahora
                    </a>
                    <script type="text/javascript">
                        setTimeout(function() {
                            if (window.top !== window.self) {
                                window.top.location.href = "<t t-out="slide.website_url"/>";
                            }
                        }, 200);
                    </script>
                    <style>
                        #AcademyDeliverableViewer, #PDFSlideViewer, #VideoViewer, #ImageViewer, #GoogleDocViewer { display: none !important; }
                    </style>
                 </div>
            </xpath>
        </template>
    </data>
</odoo>
