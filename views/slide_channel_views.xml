<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- VISTA DE BÚSQUEDA DEL ADMINISTRADOR -->
    <record id="view_slide_channel_search_university_admin" model="ir.ui.view">
        <field name="name">slide.channel.search.university.admin</field>
        <field name="model">slide.channel</field>
        <field name="arch" type="xml">
            <search string="Cursos Universitarios">
                <field name="name" string="Curso"/>
                <field name="director_academico_ids"/>
                <filter string="Pendientes de Revisión" name="revisar" domain="[('estado_universidad', 'in', ['presentado', 'subsanacion'])]"/>
                <filter string="Programados" name="programado" domain="[('estado_universidad', '=', 'programado')]"/>
                <filter string="Publicados" name="publicado" domain="[('estado_universidad', '=', 'publicado')]"/>
                <separator/>
                <filter string="Masters" name="master" domain="[('tipo_curso', '=', 'master')]"/>
                <filter string="Microcredenciales" name="microcredencial" domain="[('tipo_curso', '=', 'microcredencial')]"/>
                <group expand="0" string="Agrupar por">
                    <filter string="Estado" name="group_estado" context="{'group_by': 'estado_universidad'}"/>
                    <filter string="Tipo" name="group_tipo" context="{'group_by': 'tipo_curso'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- HERENCIA KANBAN PARA OCULTAR FINANCIEROS (GLOBAL) -->
    <!-- Heredamos de la vista de website_sale_slides para poder modificar los campos que ella añade -->
    <record id="view_slide_channel_kanban_university_financial_hide" model="ir.ui.view">
        <field name="name">slide.channel.kanban.university.financial.hide</field>
        <field name="model">slide.channel</field>
        <field name="inherit_id" ref="website_sale_slides.slide_channel_view_kanban"/>
        <field name="arch" type="xml">
             <data>
                 <!-- Ocultar ingresos por venta de productos para no administradores -->
                 <xpath expr="//field[@name='product_sale_revenues']" position="attributes">
                    <attribute name="groups">elearning_universidad.grupo_administrador_universidad</attribute>
                 </xpath>
                 <!-- Ocultar etiqueta de ingresos por venta de productos para no administradores -->
                 <xpath expr="//label[@for='product_sale_revenues']" position="attributes">
                    <attribute name="groups">elearning_universidad.grupo_administrador_universidad</attribute>
                 </xpath>
             </data>
        </field>
    </record>

    <!-- VISTA DE LISTA PARA EL ADMINISTRADOR -->
    <record id="view_slide_channel_tree_university_admin" model="ir.ui.view">
        <field name="name">slide.channel.tree.university.admin</field>
        <field name="model">slide.channel</field>
        <field name="arch" type="xml">
            <list string="Revisión de Cursos" create="false" decoration-info="estado_universidad == 'presentado'" decoration-warning="estado_universidad == 'subsanacion'" decoration-success="estado_universidad == 'publicado'">
                <field name="name"/>
                <field name="tipo_curso"/>
                <field name="director_academico_ids" widget="many2many_tags" optional="show"/>
                <field name="total_time" sum="Total Horas" optional="hide" widget="float_time"/>
                <field name="precio_curso" widget="monetary" optional="show"
                       groups="elearning_universidad.grupo_administrador_universidad"/>
                <field name="estado_universidad" widget="badge" decoration-info="estado_universidad == 'presentado'" decoration-warning="estado_universidad == 'subsanacion'" decoration-success="estado_universidad == 'publicado'"/>
            </list>
        </field>
    </record>

    <!-- ACCIÓN: REVISIÓN DE CURSOS -->
    <record id="action_universidad_revision" model="ir.actions.act_window">
        <field name="name">Revisión</field>
        <field name="res_model">slide.channel</field>
        <field name="view_mode">list,form</field>
        <field name="view_id" ref="view_slide_channel_tree_university_admin"/>
        <field name="search_view_id" ref="view_slide_channel_search_university_admin"/>
        <field name="domain">[('tipo_curso', '!=', 'asignatura')]</field>
        <field name="context">{'search_default_revisar': 1, 'create': False}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay cursos pendientes de revisión.
            </p>
            <p>
                Aquí aparecerán los Masters y Microcredenciales que requieren validación.
            </p>
        </field>
    </record>

    <!-- HERENCIA DE FORMULARIO: WORKFLOW Y CONFIGURACIÓN -->
    <record id="view_slide_channel_form_university" model="ir.ui.view">
        <field name="name">slide.channel.form.university</field>
        <field name="model">slide.channel</field>
        <field name="inherit_id" ref="website_slides.view_slide_channel_form"/>
        <field name="arch" type="xml">
            <!-- Deshabilitar la creación desde el formulario para evitar salto de restricción -->
            <xpath expr="//form" position="attributes">
                <attribute name="create">false</attribute>
            </xpath>

            <!-- Ocultar botón de ventas para usuarios que no son administradores -->
            <xpath expr="//div[@name='button_box']/button[@name='action_view_sales']" position="attributes">
                <attribute name="groups">elearning_universidad.grupo_administrador_universidad</attribute>
            </xpath>
            
            <!-- Inyectar campos técnicos auxiliares para el control de la interfaz -->
            <xpath expr="//header" position="before">
                 <field name="can_manage_config" invisible="1"/>
                 <field name="can_see_financials" invisible="1"/>
                 <field name="can_manage_members" invisible="1"/>
                 <field name="is_university_admin" invisible="1"/>
                 <field name="is_exclusive_teacher" invisible="1"/>
            </xpath>
            
            <!-- Insertar botones de flujo de trabajo en la cabecera -->
            <xpath expr="//header" position="inside">
                <!-- Botones para Docentes/Directores (Ocultos para Admins) -->
                <button name="action_presentar" string="Presentar para Revisión" type="object" 
                        class="btn-primary" 
                        groups="elearning_universidad.grupo_director_academico"
                        invisible="is_university_admin or (estado_universidad != 'borrador' or tipo_curso == 'asignatura') or context.get('hide_workflow_buttons')"/>
                
                <button name="action_subsanar" string="Subsanar y Presentar" type="object" 
                        class="btn-primary"
                        groups="elearning_universidad.grupo_director_academico"
                        invisible="is_university_admin or (estado_universidad != 'rechazado') or context.get('hide_workflow_buttons')"/>
                
                <!-- Botones exclusivos del Administrador -->
                <button name="%(elearning_universidad.action_slide_channel_reject_wizard)d" string="Rechazar" type="action" 
                        class="btn-secondary" 
                        groups="elearning_universidad.grupo_administrador_universidad"
                        invisible="estado_universidad not in ['presentado', 'subsanacion'] or context.get('hide_workflow_buttons')"
                        context="{'default_channel_id': id}"/>
                
                <button name="%(elearning_universidad.action_slide_channel_schedule_wizard)d" string="Programar Publicación" type="action" 
                        class="btn-info" 
                        groups="elearning_universidad.grupo_administrador_universidad"
                        invisible="(estado_universidad not in ['presentado', 'subsanacion'] and not (tipo_curso == 'asignatura' and estado_universidad == 'borrador')) or context.get('hide_workflow_buttons')"
                        context="{'default_channel_id': id}"/>

                <button name="action_publicar" string="Publicar Ahora" type="object" 
                        class="btn-success"
                        groups="elearning_universidad.grupo_administrador_universidad,elearning_universidad.grupo_director_academico"
                        invisible="not can_manage_config or (estado_universidad not in ['presentado', 'subsanacion', 'programado'] and not (tipo_curso == 'asignatura' and estado_universidad == 'borrador')) or (not is_university_admin and tipo_curso != 'asignatura') or context.get('hide_workflow_buttons')"/>
                
                <button name="action_finalizar" string="Finalizar Curso" type="object" 
                        class="btn-danger"
                        groups="elearning_universidad.grupo_administrador_universidad"
                        confirm="¿Está seguro de que desea finalizar y archivar este curso? Esta acción es irreversible desde el portal."
                        invisible="estado_universidad != 'publicado' or tipo_curso not in ('master', 'microcredencial') or context.get('hide_workflow_buttons')"/>
                
                <field name="estado_universidad" widget="statusbar" statusbar_visible="borrador,publicado" invisible="tipo_curso != 'asignatura'"/>
                <field name="estado_universidad" widget="statusbar" statusbar_visible="borrador,presentado,publicado,finalizado" invisible="tipo_curso == 'asignatura' or context.get('hide_workflow_buttons')"/>
            </xpath>

            <!-- Añadir campo tipo_curso fuera del notebook para contexto -->
            <xpath expr="//notebook" position="before">
                <field name="tipo_curso" invisible="1"/>
            </xpath>
            
            <!-- Ocultar pestaña de opciones para docentes en masters y microcredenciales -->
            <xpath expr="//notebook/page[@name='options']" position="attributes">
                <attribute name="invisible">is_exclusive_teacher and tipo_curso in ['master', 'microcredencial']</attribute>
            </xpath>

            <!-- Ocultar pestaña de reglas de karma -->
            <xpath expr="//notebook/page[@name='karma_rules']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <!-- Ocultar sección de comentarios para no administradores -->
            <xpath expr="//field[@name='allow_comment']/.." position="attributes">
                <attribute name="invisible">not is_university_admin</attribute>
            </xpath>

            <!-- Insertar grupos de configuración académica universitaria -->
            <xpath expr="//notebook/page[@name='options']" position="inside">
                 <group string="Gestión Académica Universitaria">
                     <group>
                         <field name="tipo_curso" readonly="1" force_save="1"/>
                         <field name="director_academico_ids" widget="many2many_tags" 
                                readonly="not is_university_admin" 
                                required="tipo_curso in ['master', 'microcredencial']"
                                invisible="tipo_curso == 'asignatura'"/>
                         <field name="personal_docente_ids" widget="many2many_tags" 
                                invisible="tipo_curso == 'master'"
                                readonly="not can_manage_members"
                                required="tipo_curso == 'asignatura'"/>
                         <field name="upload_limit_mb" readonly="not can_manage_config"/>
                     </group>
                     <group>
                         <field name="master_id" 
                                invisible="tipo_curso != 'asignatura' or context.get('locked_master_context') or is_exclusive_teacher or not master_id" 
                                readonly="1"/>
                     </group>
                 </group>
                 <group string="Certificación" invisible="tipo_curso == 'asignatura' or (not is_university_admin and not tiene_titulo)">
                      <group>
                          <field name="tiene_titulo" readonly="not is_university_admin" force_save="1"/>
                          <field name="plantilla_titulo" invisible="not tiene_titulo" required="tiene_titulo" readonly="not is_university_admin"/>
                          <field name="politica_emision" invisible="not tiene_titulo" widget="radio" required="tiene_titulo" readonly="not is_university_admin"/>
                      </group>
                      <group>
                          <field name="fecha_programada_publicacion" invisible="1"/>
                          <field name="motivo_rechazo" invisible="1"/>
                      </group>
                 </group>
            </xpath>

            <!-- Inyectar posición para el precio en la política de inscripción -->
            <xpath expr="//field[@name='enroll']" position="after">
            </xpath>
            <!-- Ocultar campo de producto nativo -->
            <xpath expr="//field[@name='product_id']" position="attributes">
                 <attribute name="invisible">1</attribute>
            </xpath>
            <!-- Insertar campo de precio del curso -->
            <xpath expr="//field[@name='product_id']" position="after">
                 <field name="precio_curso" 
                        readonly="not can_manage_config"
                        invisible="enroll != 'payment'"/>
            </xpath>
            
            <!-- Ocultar campo de usuario responsable nativo -->
            <xpath expr="//field[@name='user_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <!-- Ocultar campo de sitio web nativo -->
            <xpath expr="//field[@name='website_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <!-- Ocultar grupo contenedor del sitio web -->
            <xpath expr="//field[@name='website_id']/.." position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            
            <!-- Ocultar grupo de política de inscripción si no aplica -->
            <xpath expr="//field[@name='enroll']/.." position="attributes">
                <attribute name="invisible">not can_see_financials or tipo_curso == 'asignatura'</attribute>
            </xpath>
            <!-- Ocultar grupo de tipo de canal -->
            <xpath expr="//field[@name='channel_type']/.." position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <!-- Ocultar campo de tipo de canal en asignaturas -->
            <xpath expr="//field[@name='channel_type']" position="attributes">
                <attribute name="invisible">tipo_curso == 'asignatura'</attribute>
            </xpath>

            <!-- Hacer el nombre de solo lectura según permisos -->
            <xpath expr="//field[@name='name']" position="attributes">
                <attribute name="readonly">not can_manage_config</attribute>
            </xpath>
            <!-- Hacer la descripción de solo lectura según permisos -->
            <xpath expr="//field[@name='description']" position="attributes">
                <attribute name="readonly">not can_manage_config</attribute>
            </xpath>

            <!-- Ocultar lista de diapositivas original en Masters -->
            <xpath expr="//field[@name='slide_ids']" position="attributes">
                <attribute name="context">{'default_channel_id': id, 'form_view_ref' : 'website_slides.view_slide_slide_form_wo_channel_id', 'default_parent_course_type': tipo_curso}</attribute>
                <attribute name="invisible">tipo_curso == 'master'</attribute>
            </xpath>
            
            <!-- LOGICA DE MASTER: Botón Exclusivo + Lista Restringida -->
            <xpath expr="//field[@name='slide_ids']" position="after">
                <!-- Botón "Agregar Asignatura" INTEGRADO EN LA LISTA (sin botón externo) -->
                
                <!-- Lista para Masters: Solo permite Sections y visualizar Asignaturas -->
                <field name="slide_ids" 
                       invisible="tipo_curso != 'master'" 
                       widget="slide_category_one2many" 
                       mode="list" 
                       context="{'default_channel_id': id, 'default_is_category': True, 'form_view_ref': 'elearning_universidad.view_slide_slide_form_university_simple'}">
                     <list decoration-bf="is_category" editable="bottom" delete="1">
                        <field name="sequence" widget="handle"/>
                        <field name="name"/>
                        <field name="slide_category" invisible="slide_category == 'category'"/>
                        <field name="completion_time" widget="float_time" optional="show"/>
                        <field name="es_evaluable" optional="show" force_save="1"/>
                        <field name="is_preview" string="Preview" optional="hide"/>
                        <field name="is_published" string="Published" optional="hide"/>
                        <field name="is_category" column_invisible="True"/>
                        <field name="channel_id" column_invisible="True"/>
                        <field name="asignatura_id" column_invisible="True"/> 
                        <!-- Nota: asignatura_id visible para ver qué vinculamos, o invisible si preferimos solo 'name' -->
                        
                        <control>
                            <!-- Botón personalizado que añade Asignatura - "Se comporta igual que Agregar Contenido" -->
                            <button name="action_open_add_asignatura" 
                                    string="Agregar Asignatura" 
                                    type="object" 
                                    context="{'default_slide_category': 'sub_course', 'force_master_content': True}"/>
                                    
                            <!-- SOLO permitimos agregar Secciones por la vía rápida -->
                            <create name="add_slide_section" string="Agregar Sección" context="{'default_is_category': True}"/>
                        </control>
                     </list>
                </field>
            </xpath>
            
            <!-- Ocultar botón 'Add Certification' nativo de website_slides_survey -->
            <xpath expr="//field[@name='slide_ids']//create[@name='add_slide_certificate']" position="replace">
            </xpath>

            <!-- Añadir columna de evaluable en la lista de contenido -->
            <xpath expr="//field[@name='slide_ids']/list/field[@name='slide_category']" position="after">
                <field name="es_evaluable" optional="show" force_save="1"/>
            </xpath> 

            <!-- Ocultar botón de inscripción nativo -->
            <xpath expr="//button[@name='action_channel_enroll']" position="attributes">
                 <attribute name="invisible">1</attribute>
            </xpath>

            <!-- Ocultar botón de invitación nativo -->
            <xpath expr="//button[@name='action_channel_invite']" position="attributes">
                 <attribute name="invisible">1</attribute>
            </xpath>

            <!-- Añadir botón de confirmación de programación en cabecera -->
            <xpath expr="//header" position="inside">
                 <button name="action_confirmar_programacion" 
                         string="Confirmar Programación" 
                         type="object" 
                         class="btn-primary"
                         invisible="not fecha_programada_publicacion or estado_universidad in ['programado', 'publicado', 'finalizado'] or context.get('hide_workflow_buttons')"/>
            </xpath>
      
            <!-- Inyectar campo de fecha programada si no existe -->
             <xpath expr="//field[@name='channel_type']" position="after">
                 <field name="fecha_programada_publicacion" invisible="1"/>
             </xpath>

             <!-- Ocultar TODO el chatter para Administradores de Universidad  -->
             <xpath expr="//chatter" position="attributes">
                 <attribute name="invisible">is_university_admin</attribute>
             </xpath>
            
        </field>
    </record>

    <!-- ACCESO A MENÚS PARA GRUPOS PERSONALIZADOS -->
    <!-- Permitimos que Docentes y Directores vean el menú raíz de eLearning sin ser 'Encargados' -->
    <record id="website_slides.website_slides_menu_root" model="ir.ui.menu">
        <field name="groups_id" eval="[(4, ref('elearning_universidad.grupo_personal_docente')), (4, ref('elearning_universidad.grupo_director_academico'))]"/>
    </record>

</odoo>
